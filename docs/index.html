<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LibItemsFlow 借用台</title>
    <style>
      :root {
        --bg: #f4f6f8;
        --card: #ffffff;
        --text: #1f2937;
        --muted: #6b7280;
        --line: #e5e7eb;
        --primary: #0b7a6f;
        --warn: #d97706;
        --error: #b42318;
        --ok: #067647;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: "Segoe UI", "Noto Sans TC", sans-serif;
      }

      .wrap {
        max-width: 860px;
        margin: 20px auto;
        padding: 0 14px 24px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 14px;
        margin-bottom: 12px;
      }

      h1 {
        margin: 0 0 4px;
        font-size: 24px;
      }

      .sub {
        margin: 0;
        font-size: 13px;
        color: var(--muted);
      }

      .field { margin-bottom: 10px; }

      label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 4px;
      }

      input, button {
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        padding: 10px 11px;
        font-size: 14px;
      }

      .scan-input {
        font-size: 18px;
        font-weight: 600;
        letter-spacing: 0.4px;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      button {
        border: 0;
        color: #fff;
        background: var(--primary);
        font-weight: 700;
        cursor: pointer;
      }

      button.alt { background: #475467; }

      .status {
        margin-top: 8px;
        font-size: 13px;
        min-height: 20px;
      }

      .status.ok { color: var(--ok); }
      .status.warn { color: var(--warn); }
      .status.err { color: var(--error); }

      .item-info {
        border: 1px dashed #c7d4d1;
        border-radius: 10px;
        padding: 10px;
        background: #f8fcfb;
        font-size: 13px;
      }

      .hidden { display: none; }

      .list {
        display: grid;
        gap: 8px;
      }

      .list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 8px 10px;
        background: #fbfcfd;
      }

      .list-meta {
        color: var(--muted);
        font-size: 12px;
      }

      .tiny {
        width: auto;
        padding: 6px 8px;
        border-radius: 8px;
        font-size: 12px;
      }

      .muted {
        color: var(--muted);
        font-size: 13px;
      }

      pre {
        margin: 10px 0 0;
        font-size: 12px;
        background: #f8fafc;
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 8px;
        overflow: auto;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <section class="card">
        <h1>設備借用台</h1>
        <p class="sub">先建立借用人資料，再加入多個設備，一次借出。</p>
      </section>

      <section class="card">
        <div class="field">
          <label for="apiBase">API URL</label>
          <input id="apiBase" placeholder="https://script.google.com/macros/s/.../exec" />
        </div>
        <div class="grid-2">
          <button id="saveApiBase">儲存 API URL</button>
          <button class="alt" id="resetApiBase">重設預設值</button>
        </div>
      </section>

      <section class="card">
        <div class="field">
          <label for="scanCode">掃描碼 / AssetTag / ItemID</label>
          <input id="scanCode" class="scan-input" autocomplete="off" placeholder="輸入或掃描設備碼" />
        </div>
        <div class="grid-2">
          <button id="scanLookup">查詢並加入清單</button>
          <button class="alt" id="scanClear">清空掃描欄位</button>
        </div>
        <div id="scanStatus" class="status"></div>
        <div id="itemInfo" class="item-info hidden"></div>
      </section>

      <section id="newItemCard" class="card hidden">
        <h2 style="margin:0 0 10px; font-size:18px;">找不到設備，立即新增</h2>
        <div class="field">
          <label for="newAssetTag">AssetTag</label>
          <input id="newAssetTag" />
        </div>
        <div class="field">
          <label for="newName">名稱</label>
          <input id="newName" placeholder="例如：Chromebook A" />
        </div>
        <div class="field">
          <label for="newCategory">分類</label>
          <input id="newCategory" placeholder="例如：Notebook" />
        </div>
        <div class="field">
          <label for="newLocation">位置（可選）</label>
          <input id="newLocation" />
        </div>
        <button id="createItemBtn">建立設備並加入清單</button>
        <div id="newItemStatus" class="status"></div>
      </section>

      <section class="card">
        <h2 style="margin:0 0 10px; font-size:18px;">借用資料</h2>
        <div class="field">
          <label>設備清單</label>
          <div id="borrowItemsEmpty" class="muted">尚未加入設備</div>
          <div id="borrowItemsList" class="list"></div>
        </div>
        <div class="field">
          <button class="alt" id="clearBorrowItems">清空設備清單</button>
        </div>
        <div class="field">
          <label for="borrowerName">借用人姓名</label>
          <input id="borrowerName" />
        </div>
        <div class="field">
          <label for="borrowerContact">借用人聯絡方式</label>
          <input id="borrowerContact" />
        </div>
        <div class="field">
          <label for="borrowerUnit">單位 / 班級（可選）</label>
          <input id="borrowerUnit" />
        </div>
        <div class="field">
          <label for="dueDate">預計歸還日期</label>
          <input id="dueDate" type="date" />
        </div>
        <button id="borrowSubmit">一次借出清單設備</button>
        <div id="borrowStatus" class="status"></div>
        <pre id="resultView"></pre>
      </section>
    </div>

    <script>
      const DEFAULT_API_BASE = "https://script.google.com/macros/s/AKfycbzVvH7KXNQ__H5oLpBthyYTu88m7tvtRacdx7k_LFZ2mDW-i93Q-1hC32aQmNtVuFjW/exec";
      let API_BASE = localStorage.getItem("LIBITEMSFLOW_API_BASE") || DEFAULT_API_BASE;
      API_BASE = String(API_BASE).trim().replace(/\/+$/, "");

      const state = {
        items: [],
        currentItem: null,
      };

      const el = {
        apiBase: document.getElementById("apiBase"),
        saveApiBase: document.getElementById("saveApiBase"),
        resetApiBase: document.getElementById("resetApiBase"),
        scanCode: document.getElementById("scanCode"),
        scanLookup: document.getElementById("scanLookup"),
        scanClear: document.getElementById("scanClear"),
        scanStatus: document.getElementById("scanStatus"),
        itemInfo: document.getElementById("itemInfo"),
        newItemCard: document.getElementById("newItemCard"),
        newAssetTag: document.getElementById("newAssetTag"),
        newName: document.getElementById("newName"),
        newCategory: document.getElementById("newCategory"),
        newLocation: document.getElementById("newLocation"),
        createItemBtn: document.getElementById("createItemBtn"),
        newItemStatus: document.getElementById("newItemStatus"),
        borrowItemsList: document.getElementById("borrowItemsList"),
        borrowItemsEmpty: document.getElementById("borrowItemsEmpty"),
        clearBorrowItems: document.getElementById("clearBorrowItems"),
        borrowerName: document.getElementById("borrowerName"),
        borrowerContact: document.getElementById("borrowerContact"),
        borrowerUnit: document.getElementById("borrowerUnit"),
        dueDate: document.getElementById("dueDate"),
        borrowSubmit: document.getElementById("borrowSubmit"),
        borrowStatus: document.getElementById("borrowStatus"),
        resultView: document.getElementById("resultView"),
      };

      el.apiBase.value = API_BASE;
      const today = new Date();
      const nextWeek = new Date(today);
      nextWeek.setDate(today.getDate() + 7);
      el.dueDate.value = nextWeek.toISOString().slice(0, 10);
      el.scanCode.focus();

      function showStatus(target, type, text) {
        target.className = "status " + type;
        target.textContent = text;
      }

      function clearStatus(target) {
        target.className = "status";
        target.textContent = "";
      }

      function showJson(payload) {
        el.resultView.textContent = JSON.stringify(payload, null, 2);
      }

      function normalizeBase(url) {
        return String(url || "").trim().replace(/\/+$/, "");
      }

      async function apiGet(action, query = {}) {
        const u = new URL(API_BASE);
        u.searchParams.set("action", action);
        Object.keys(query).forEach((k) => {
          if (query[k] !== "" && query[k] !== null && query[k] !== undefined) {
            u.searchParams.set(k, query[k]);
          }
        });
        const r = await fetch(u.toString());
        return r.json();
      }

      async function apiPost(action, body) {
        const u = new URL(API_BASE);
        u.searchParams.set("action", action);
        const r = await fetch(u.toString(), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        return r.json();
      }

      function matchItemByCode(items, code) {
        const c = String(code || "").trim().toLowerCase();
        return (
          items.find((x) => {
            const assetTag = String(x.AssetTag ?? "").trim().toLowerCase();
            const itemID = String(x.ItemID ?? "").trim().toLowerCase();
            return assetTag === c || itemID === c;
          }) || null
        );
      }

      function renderCurrentItem(item) {
        if (!item) {
          el.itemInfo.classList.add("hidden");
          el.itemInfo.innerHTML = "";
          return;
        }
        el.itemInfo.classList.remove("hidden");
        el.itemInfo.innerHTML = [
          `<div><strong>ItemID:</strong> ${item.ItemID || ""}</div>`,
          `<div><strong>名稱:</strong> ${item.Name || ""}</div>`,
          `<div><strong>AssetTag:</strong> ${item.AssetTag || ""}</div>`,
          `<div><strong>狀態:</strong> ${item.Status || ""}</div>`,
        ].join("");
      }

      function renderBorrowItems() {
        el.borrowItemsList.innerHTML = "";
        if (state.items.length === 0) {
          el.borrowItemsEmpty.classList.remove("hidden");
          return;
        }
        el.borrowItemsEmpty.classList.add("hidden");

        state.items.forEach((item) => {
          const row = document.createElement("div");
          row.className = "list-item";
          row.innerHTML = [
            "<div>",
            `<div><strong>${item.Name || "(未命名設備)"}</strong></div>`,
            `<div class="list-meta">${item.ItemID || ""} / ${item.AssetTag || "-"}</div>`,
            "</div>",
            `<button class="alt tiny" data-remove-item="${item.ItemID}">移除</button>`,
          ].join("");
          el.borrowItemsList.appendChild(row);
        });
      }

      function resetScanPanel() {
        state.currentItem = null;
        renderCurrentItem(null);
        el.newItemCard.classList.add("hidden");
        el.newName.value = "";
        el.newCategory.value = "";
        el.newLocation.value = "";
        clearStatus(el.newItemStatus);
      }

      function addItemToBorrowList(item) {
        if (!item || !item.ItemID) return false;
        const exists = state.items.some((x) => x.ItemID === item.ItemID);
        if (exists) return false;
        state.items.push(item);
        renderBorrowItems();
        return true;
      }

      function removeItemFromBorrowList(itemID) {
        state.items = state.items.filter((x) => x.ItemID !== itemID);
        renderBorrowItems();
      }

      async function lookupItem() {
        const code = el.scanCode.value.trim();
        resetScanPanel();
        clearStatus(el.scanStatus);
        if (!code) {
          showStatus(el.scanStatus, "warn", "請先輸入或掃描設備碼");
          return;
        }

        const payload = await apiGet("items", { search: code });
        showJson(payload);
        if (!payload.ok) {
          showStatus(el.scanStatus, "err", "查詢失敗: " + (payload.error?.message || "unknown"));
          return;
        }

        const items = Array.isArray(payload.data) ? payload.data : [];
        const found = matchItemByCode(items, code);

        if (!found) {
          showStatus(el.scanStatus, "warn", "找不到設備，請先建立");
          el.newAssetTag.value = code;
          el.newItemCard.classList.remove("hidden");
          el.newName.focus();
          return;
        }

        state.currentItem = found;
        renderCurrentItem(found);
        if (found.Status !== "AVAILABLE") {
          showStatus(el.scanStatus, "err", "設備不可借，目前狀態: " + found.Status);
          return;
        }

        const added = addItemToBorrowList(found);
        showStatus(el.scanStatus, added ? "ok" : "warn", added ? "已加入借用清單" : "此設備已在清單中");
        el.scanCode.select();
      }

      async function createItem() {
        const body = {
          Name: el.newName.value.trim(),
          Category: el.newCategory.value.trim(),
          AssetTag: el.newAssetTag.value.trim(),
          Status: "AVAILABLE",
          Location: el.newLocation.value.trim(),
          Note: "created from borrow UI",
        };

        const payload = await apiPost("items", body);
        showJson(payload);
        if (!payload.ok) {
          showStatus(el.newItemStatus, "err", "建立失敗: " + (payload.error?.message || "unknown"));
          return;
        }

        state.currentItem = payload.data;
        renderCurrentItem(state.currentItem);
        addItemToBorrowList(state.currentItem);
        el.newItemCard.classList.add("hidden");
        showStatus(el.scanStatus, "ok", "設備建立成功，已加入借用清單");
        showStatus(el.newItemStatus, "ok", "建立成功");
        el.scanCode.select();
      }

      async function submitBorrow() {
        if (state.items.length === 0) {
          showStatus(el.borrowStatus, "warn", "請先加入至少一個設備");
          return;
        }
        if (!el.borrowerName.value.trim()) {
          showStatus(el.borrowStatus, "warn", "請填借用人姓名");
          return;
        }
        if (!el.borrowerContact.value.trim()) {
          showStatus(el.borrowStatus, "warn", "請填借用人聯絡方式");
          return;
        }
        if (!el.dueDate.value) {
          showStatus(el.borrowStatus, "warn", "請填預計歸還日期");
          return;
        }

        const body = {
          ItemIDs: state.items.map((x) => x.ItemID),
          BorrowerName: el.borrowerName.value.trim(),
          BorrowerUnit: el.borrowerUnit.value.trim(),
          BorrowerContact: el.borrowerContact.value.trim(),
          LoanDate: new Date().toISOString().slice(0, 10),
          DueDate: el.dueDate.value,
          Note: "",
        };

        const payload = await apiPost("loans", body);
        showJson(payload);
        if (!payload.ok) {
          showStatus(el.borrowStatus, "err", "借用失敗: " + (payload.error?.message || "unknown"));
          return;
        }

        const count = payload.data?.itemCount || state.items.length;
        showStatus(el.borrowStatus, "ok", `借用成功，共 ${count} 件`);

        el.scanCode.value = "";
        el.borrowerName.value = "";
        el.borrowerContact.value = "";
        el.borrowerUnit.value = "";
        state.items = [];
        renderBorrowItems();
        resetScanPanel();
        el.scanCode.focus();
      }

      el.saveApiBase.addEventListener("click", () => {
        const next = normalizeBase(el.apiBase.value);
        if (!next.startsWith("http")) {
          alert("API URL 格式錯誤");
          return;
        }
        API_BASE = next;
        localStorage.setItem("LIBITEMSFLOW_API_BASE", API_BASE);
        showStatus(el.scanStatus, "ok", "API URL 已儲存");
      });

      el.resetApiBase.addEventListener("click", () => {
        API_BASE = DEFAULT_API_BASE;
        el.apiBase.value = API_BASE;
        localStorage.setItem("LIBITEMSFLOW_API_BASE", API_BASE);
        showStatus(el.scanStatus, "ok", "已重設為預設 API URL");
      });

      el.scanLookup.addEventListener("click", () => lookupItem().catch((e) => showStatus(el.scanStatus, "err", e.message)));
      el.scanClear.addEventListener("click", () => {
        el.scanCode.value = "";
        resetScanPanel();
        showJson({});
        el.scanCode.focus();
      });
      el.scanCode.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          lookupItem().catch((err) => showStatus(el.scanStatus, "err", err.message));
        }
      });

      el.createItemBtn.addEventListener("click", () => createItem().catch((e) => showStatus(el.newItemStatus, "err", e.message)));
      el.borrowSubmit.addEventListener("click", () => submitBorrow().catch((e) => showStatus(el.borrowStatus, "err", e.message)));
      el.clearBorrowItems.addEventListener("click", () => {
        state.items = [];
        renderBorrowItems();
        showStatus(el.borrowStatus, "ok", "已清空設備清單");
      });
      el.borrowItemsList.addEventListener("click", (event) => {
        const btn = event.target.closest("[data-remove-item]");
        if (!btn) return;
        removeItemFromBorrowList(btn.getAttribute("data-remove-item"));
      });

      renderBorrowItems();
    </script>
  </body>
</html>
