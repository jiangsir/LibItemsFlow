<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LibItemsFlow MVP</title>
    <style>
      :root {
        --bg: linear-gradient(160deg, #f4f0e6 0%, #dbe9e3 100%);
        --card: #fffdf8;
        --ink: #21312c;
        --muted: #5a6a64;
        --accent: #0f7b6c;
        --accent-2: #c4572d;
        --ok: #1d7a42;
        --err: #af2e35;
        --line: #d7ddd8;
      }

      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Segoe UI", "Noto Sans TC", sans-serif;
        color: var(--ink);
        background: var(--bg);
      }

      .wrap {
        max-width: 1100px;
        margin: 24px auto;
        padding: 0 16px 28px;
      }

      .hero {
        background: radial-gradient(circle at 90% 0%, #ffe2b7 0%, transparent 35%), var(--card);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 18px 20px;
        margin-bottom: 16px;
      }

      h1 { margin: 0 0 6px; font-size: 28px; letter-spacing: 0.2px; }
      .sub { margin: 0; color: var(--muted); }

      .grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(12, 1fr);
      }

      .card {
        grid-column: span 12;
        border: 1px solid var(--line);
        background: var(--card);
        border-radius: 14px;
        padding: 14px;
      }

      .card h2 { margin: 0 0 10px; font-size: 18px; }

      .row {
        display: grid;
        gap: 8px;
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .row-3 {
        display: grid;
        gap: 8px;
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      label {
        display: block;
        font-size: 13px;
        margin-bottom: 4px;
        color: var(--muted);
      }

      input, select, button, textarea {
        width: 100%;
        border-radius: 10px;
        border: 1px solid #cfd7d1;
        padding: 10px 11px;
        font-size: 14px;
        font-family: inherit;
      }

      button {
        cursor: pointer;
        border: 0;
        color: #fff;
        background: var(--accent);
        font-weight: 600;
      }
      button.secondary { background: var(--accent-2); }

      .status {
        margin: 10px 0 0;
        min-height: 20px;
        font-size: 13px;
      }
      .status.ok { color: var(--ok); }
      .status.err { color: var(--err); }

      pre {
        margin: 8px 0 0;
        border: 1px dashed var(--line);
        border-radius: 10px;
        background: #f6faf7;
        padding: 10px;
        overflow: auto;
        font-size: 12px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      th, td {
        border-bottom: 1px solid #e8ece9;
        text-align: left;
        font-size: 13px;
        padding: 8px 6px;
      }
      th { color: var(--muted); font-weight: 600; }

      @media (min-width: 900px) {
        .loan-card { grid-column: span 6; }
        .return-card { grid-column: span 6; }
        .list-card { grid-column: span 12; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <section class="hero">
        <h1>LibItemsFlow MVP</h1>
        <p class="sub">借用、歸還、查詢清單（ACTIVE / OVERDUE / RETURNED）</p>
        <div class="row" style="margin-top: 10px;">
          <div>
            <label for="apiBaseInput">API Base URL</label>
            <input id="apiBaseInput" placeholder="https://script.google.com/macros/s/.../exec" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="apiBaseSave">儲存 API URL</button>
          </div>
        </div>
        <p class="sub">目前 API Base: <code id="apiBaseLabel"></code></p>
      </section>

      <div class="grid">
        <section class="card loan-card">
          <h2>建立借用</h2>
          <div class="row">
            <div>
              <label for="loanItemId">ItemID</label>
              <input id="loanItemId" placeholder="ITEM_..." />
            </div>
            <div>
              <label for="loanBorrowerName">BorrowerName</label>
              <input id="loanBorrowerName" placeholder="借用人" />
            </div>
            <div>
              <label for="loanBorrowerContact">BorrowerContact</label>
              <input id="loanBorrowerContact" placeholder="0912..." />
            </div>
            <div>
              <label for="loanBorrowerUnit">BorrowerUnit</label>
              <input id="loanBorrowerUnit" placeholder="單位（可空白）" />
            </div>
            <div>
              <label for="loanDate">LoanDate</label>
              <input id="loanDate" type="date" />
            </div>
            <div>
              <label for="loanDueDate">DueDate</label>
              <input id="loanDueDate" type="date" />
            </div>
          </div>
          <div style="margin-top: 8px;">
            <label for="loanNote">Note</label>
            <textarea id="loanNote" rows="2" placeholder="備註（可空白）"></textarea>
          </div>
          <div style="margin-top: 10px;">
            <button id="loanSubmit">送出借用</button>
          </div>
          <div id="loanStatus" class="status"></div>
          <pre id="loanResult"></pre>
        </section>

        <section class="card return-card">
          <h2>建立歸還</h2>
          <div class="row">
            <div>
              <label for="returnLoanId">LoanID</label>
              <input id="returnLoanId" placeholder="LOAN_..." />
            </div>
            <div>
              <label for="returnDate">ReturnDate</label>
              <input id="returnDate" type="date" />
            </div>
          </div>
          <div style="margin-top: 8px;">
            <label for="returnNote">Note</label>
            <textarea id="returnNote" rows="2" placeholder="備註（可空白）"></textarea>
          </div>
          <div style="margin-top: 10px;">
            <button class="secondary" id="returnSubmit">送出歸還</button>
          </div>
          <div id="returnStatus" class="status"></div>
          <pre id="returnResult"></pre>
        </section>

        <section class="card list-card">
          <h2>借用查詢</h2>
          <div class="row-3">
            <div>
              <label for="listStatus">Status</label>
              <select id="listStatus">
                <option value="ACTIVE">ACTIVE</option>
                <option value="OVERDUE">OVERDUE</option>
                <option value="RETURNED">RETURNED</option>
              </select>
            </div>
            <div>
              <label for="listBorrower">Borrower 搜尋（可空白）</label>
              <input id="listBorrower" placeholder="例如 王小明" />
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="listLoad">載入清單</button>
            </div>
          </div>
          <div id="listStatusText" class="status"></div>
          <table>
            <thead>
              <tr>
                <th>LoanID</th>
                <th>ItemID</th>
                <th>Borrower</th>
                <th>Status</th>
                <th>LoanDate</th>
                <th>DueDate</th>
                <th>ReturnDate</th>
              </tr>
            </thead>
            <tbody id="listBody"></tbody>
          </table>
          <pre id="listResult"></pre>
        </section>
      </div>
    </div>

    <script>
      const DEFAULT_API_BASE = "https://script.google.com/macros/s/AKfycbzVvH7KXNQ__H5oLpBthyYTu88m7tvtRacdx7k_LFZ2mDW-i93Q-1hC32aQmNtVuFjW/exec";
      const runtimeBase = location.hostname === "script.google.com"
        ? (location.origin + location.pathname)
        : DEFAULT_API_BASE;
      let API_BASE = localStorage.getItem("LIBITEMSFLOW_API_BASE") || runtimeBase;
      const todayStr = new Date().toISOString().slice(0, 10);

      const els = {
        apiBaseLabel: document.getElementById("apiBaseLabel"),
        apiBaseInput: document.getElementById("apiBaseInput"),
        apiBaseSave: document.getElementById("apiBaseSave"),
        loanItemId: document.getElementById("loanItemId"),
        loanBorrowerName: document.getElementById("loanBorrowerName"),
        loanBorrowerContact: document.getElementById("loanBorrowerContact"),
        loanBorrowerUnit: document.getElementById("loanBorrowerUnit"),
        loanDate: document.getElementById("loanDate"),
        loanDueDate: document.getElementById("loanDueDate"),
        loanNote: document.getElementById("loanNote"),
        loanSubmit: document.getElementById("loanSubmit"),
        loanStatus: document.getElementById("loanStatus"),
        loanResult: document.getElementById("loanResult"),
        returnLoanId: document.getElementById("returnLoanId"),
        returnDate: document.getElementById("returnDate"),
        returnNote: document.getElementById("returnNote"),
        returnSubmit: document.getElementById("returnSubmit"),
        returnStatus: document.getElementById("returnStatus"),
        returnResult: document.getElementById("returnResult"),
        listStatus: document.getElementById("listStatus"),
        listBorrower: document.getElementById("listBorrower"),
        listLoad: document.getElementById("listLoad"),
        listStatusText: document.getElementById("listStatusText"),
        listBody: document.getElementById("listBody"),
        listResult: document.getElementById("listResult"),
      };

      function normalizeApiBase(url) {
        return String(url || "").trim().replace(/\/+$/, "");
      }

      function refreshApiBaseUi() {
        els.apiBaseLabel.textContent = API_BASE;
        els.apiBaseInput.value = API_BASE;
      }

      API_BASE = normalizeApiBase(API_BASE);
      refreshApiBaseUi();
      els.loanDate.value = todayStr;
      els.loanDueDate.value = todayStr;
      els.returnDate.value = todayStr;

      function setStatus(el, ok, text) {
        el.className = "status " + (ok ? "ok" : "err");
        el.textContent = text;
      }

      function pretty(el, payload) {
        el.textContent = JSON.stringify(payload, null, 2);
      }

      async function apiGet(action, query = {}) {
        const url = new URL(API_BASE);
        url.searchParams.set("action", action);
        Object.keys(query).forEach((k) => {
          if (query[k] !== "" && query[k] !== null && query[k] !== undefined) {
            url.searchParams.set(k, query[k]);
          }
        });
        const res = await fetch(url.toString(), { method: "GET" });
        return res.json();
      }

      async function apiPost(action, data) {
        const url = new URL(API_BASE);
        url.searchParams.set("action", action);
        const res = await fetch(url.toString(), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        return res.json();
      }

      function safeMessage(payload) {
        if (payload && payload.error && payload.error.message) return payload.error.message;
        return "Unknown error";
      }

      async function submitLoan() {
        const body = {
          ItemID: els.loanItemId.value.trim(),
          BorrowerName: els.loanBorrowerName.value.trim(),
          BorrowerUnit: els.loanBorrowerUnit.value.trim(),
          BorrowerContact: els.loanBorrowerContact.value.trim(),
          LoanDate: els.loanDate.value,
          DueDate: els.loanDueDate.value,
          Note: els.loanNote.value.trim(),
        };
        const payload = await apiPost("loans", body);
        pretty(els.loanResult, payload);
        if (payload.ok) {
          setStatus(els.loanStatus, true, "借用成功");
          if (payload.data && payload.data.LoanID) {
            els.returnLoanId.value = payload.data.LoanID;
          }
          loadLoans();
        } else {
          setStatus(els.loanStatus, false, "借用失敗: " + safeMessage(payload));
        }
      }

      async function submitReturn() {
        const body = {
          LoanID: els.returnLoanId.value.trim(),
          ReturnDate: els.returnDate.value,
          Note: els.returnNote.value.trim(),
        };
        const payload = await apiPost("returns", body);
        pretty(els.returnResult, payload);
        if (payload.ok) {
          setStatus(els.returnStatus, true, "歸還成功");
          loadLoans();
        } else {
          setStatus(els.returnStatus, false, "歸還失敗: " + safeMessage(payload));
        }
      }

      async function loadLoans() {
        const payload = await apiGet("loans", {
          status: els.listStatus.value,
          borrower: els.listBorrower.value.trim(),
        });
        pretty(els.listResult, payload);
        if (!payload.ok) {
          setStatus(els.listStatusText, false, "查詢失敗: " + safeMessage(payload));
          return;
        }
        const rows = Array.isArray(payload.data) ? payload.data : [];
        setStatus(els.listStatusText, true, `查詢成功，共 ${rows.length} 筆`);
        els.listBody.innerHTML = rows.map((r) => `
          <tr>
            <td>${r.LoanID || ""}</td>
            <td>${r.ItemID || ""}</td>
            <td>${r.BorrowerName || ""}</td>
            <td>${r.Status || ""}</td>
            <td>${r.LoanDate || ""}</td>
            <td>${r.DueDate || ""}</td>
            <td>${r.ReturnDate || ""}</td>
          </tr>
        `).join("");
      }

      els.loanSubmit.addEventListener("click", () => submitLoan().catch((e) => setStatus(els.loanStatus, false, e.message)));
      els.returnSubmit.addEventListener("click", () => submitReturn().catch((e) => setStatus(els.returnStatus, false, e.message)));
      els.listLoad.addEventListener("click", () => loadLoans().catch((e) => setStatus(els.listStatusText, false, e.message)));
      els.apiBaseSave.addEventListener("click", () => {
        const next = normalizeApiBase(els.apiBaseInput.value);
        if (!next || !next.startsWith("http")) {
          alert("API URL 格式不正確");
          return;
        }
        API_BASE = next;
        localStorage.setItem("LIBITEMSFLOW_API_BASE", API_BASE);
        refreshApiBaseUi();
        loadLoans().catch(() => {});
      });

      loadLoans().catch(() => {});
    </script>
  </body>
</html>
